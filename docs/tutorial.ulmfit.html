---

title: Transfer learning in text

keywords: fastai
sidebar: home_sidebar

summary: "How to fine-tune a language model and train a classifier"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/38_tutorial.ulmfit.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.text.all</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># all_slow</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Finetune-a-pretrained-Language-Model">Finetune a pretrained Language Model<a class="anchor-link" href="#Finetune-a-pretrained-Language-Model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we get our data and tokenize it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">IMDB_SAMPLE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;texts.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we put it in a <a href="/data.core#DataSource"><code>DataSource</code></a>. For a language model, we don't have targets, so there is only one transform to numericalize the texts.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">()(</span><span class="n">df</span><span class="p">)</span>
<span class="n">tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Numericalize</span><span class="p">()]</span>
<span class="n">dsrc</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="n">tfms</span><span class="p">],</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">LMDataLoader</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we use that <a href="/data.core#DataSource"><code>DataSource</code></a> to create a <a href="/data.core#DataBunch"><code>DataBunch</code></a>. Here the class of <a href="/data.core#TfmdDL"><code>TfmdDL</code></a> we need to use is <a href="/text.data#LMDataLoader"><code>LMDataLoader</code></a> which will concatenate all the texts in a source (with a shuffle at each epoch for the training set), split it in <code>bs</code> chunks then read continuously through it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">dsrc</span><span class="o">.</span><span class="n">databunch</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">72</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or more simply with a factory method:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">TextDataBunch</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">is_lm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">valid_col</span><span class="o">=</span><span class="s1">&#39;is_valid&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>text_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj this is a extremely well - made film . xxmaj the acting , script and camera - work are all first - rate . xxmaj the music is good , too , though it is mostly early in the film , when things are still relatively xxunk . xxmaj there are no really xxunk in the cast , though several faces will be familiar . xxmaj the entire cast does</td>
      <td>xxmaj this is a extremely well - made film . xxmaj the acting , script and camera - work are all first - rate . xxmaj the music is good , too , though it is mostly early in the film , when things are still relatively xxunk . xxmaj there are no really xxunk in the cast , though several faces will be familiar . xxmaj the entire cast does an</td>
    </tr>
    <tr>
      <th>1</th>
      <td>. xxmaj before i go further , it seems only fair that i point out the following so a reader can see if xxmaj i 'm xxunk or not . xxmaj i 'm trying to be objective , for the record . \n\n i tend to enjoy xxmaj maher 's xxup xxunk show now and then , though i rarely think he 's the source of the humor . i do n't</td>
      <td>xxmaj before i go further , it seems only fair that i point out the following so a reader can see if xxmaj i 'm xxunk or not . xxmaj i 'm trying to be objective , for the record . \n\n i tend to enjoy xxmaj maher 's xxup xxunk show now and then , though i rarely think he 's the source of the humor . i do n't really</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we have a convenience method to directly grab a <a href="/learner#Learner"><code>Learner</code></a> from it, using the <a href="/text.models.awdlstm#AWD_LSTM"><code>AWD_LSTM</code></a> architecture.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">language_model_learner</span><span class="p">(</span><span class="n">dbunch</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">Perplexity</span><span class="p">()],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">opt_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.537915</td>
      <td>4.057219</td>
      <td>0.274963</td>
      <td>57.813309</td>
      <td>00:09</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.315029</td>
      <td>4.153787</td>
      <td>0.261169</td>
      <td>63.674690</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>1</td>
      <td>4.140304</td>
      <td>4.086970</td>
      <td>0.268618</td>
      <td>59.559143</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3.815153</td>
      <td>4.053044</td>
      <td>0.273681</td>
      <td>57.572433</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3.428173</td>
      <td>4.084964</td>
      <td>0.272838</td>
      <td>59.439785</td>
      <td>00:10</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once we have fine-tuned the pretrained language model to this corpus, we save the encoder since we will use it for the classifier.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>input</th>
      <th>target</th>
      <th>pred</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos i found myself very caught up in this movie , at least at the beginning , and any credit i give to this movie , is xxmaj xxunk xxmaj xxunk , she was fantastic ! ! xxmaj but that s where it ends . i seem to be very good at xxunk out who the killer is , and i like it when a movie is able to completely xxunk me</td>
      <td>i found myself very caught up in this movie , at least at the beginning , and any credit i give to this movie , is xxmaj xxunk xxmaj xxunk , she was fantastic ! ! xxmaj but that s where it ends . i seem to be very good at xxunk out who the killer is , and i like it when a movie is able to completely xxunk me ,</td>
      <td>xxmaj was this watching excited up in this movie . and least at the beginning , but i bit i had to the movie is is that xxunk xxmaj xxunk . the was the . xxmaj xxmaj the i 's not it was ! xxmaj think to be a disappointed at watching out the i movie was , but i think to . i movie is shot to make xxunk the .</td>
    </tr>
    <tr>
      <th>1</th>
      <td>logic , not only is the acting terrible , not only is the entire movie offensive from start to finish , not only is the direction as amateurish as you can find , but they actually want you to pay to see this film . xxmaj maybe if it was free … n xxrep 3 a h , it would still be a waste of time . \n\n xxmaj usually xxmaj i</td>
      <td>, not only is the acting terrible , not only is the entire movie offensive from start to finish , not only is the direction as amateurish as you can find , but they actually want you to pay to see this film . xxmaj maybe if it was free … n xxrep 3 a h , it would still be a waste of time . \n\n xxmaj usually xxmaj i 'd</td>
      <td>, and only is the film as , but only is the acting movie just , start to finish , but only is the acting and xxunk as it can find , but also also have to to see for see this movie . xxmaj it it you was a , i xxrep 3 o xxunk xxrep it would have be a little of time . xxbos xxmaj the i i 'm</td>
    </tr>
    <tr>
      <th>2</th>
      <td>was xxunk , cliché , or just plain stupid . xxmaj for instance the name of the camp is " camp blood " ( lame ) , the name of the clown is " the killer clown " ( lame ) . xxmaj what is a clown doing in a forest anyway ? xxmaj was that the only mask they could find ? 3 . xxmaj the last but certainly the least</td>
      <td>xxunk , cliché , or just plain stupid . xxmaj for instance the name of the camp is " camp blood " ( lame ) , the name of the clown is " the killer clown " ( lame ) . xxmaj what is a clown doing in a forest anyway ? xxmaj was that the only mask they could find ? 3 . xxmaj the last but certainly the least was</td>
      <td>a by and - and not plain stupid . xxmaj the me , xxunk of the film is " xxunk " " . xxunk ) . but word of the film is " the xxmaj " " ( xxunk ) . xxmaj the makes the joke doing in a car is ? xxmaj and that the name thing you could make ? xxmaj . xxmaj the xxunk scene xxunk the worst was</td>
    </tr>
    <tr>
      <th>3</th>
      <td>wife 's teeth and cut out her tongue with no xxunk ? xxmaj overall awesome flick , but not for everyone . xxbos xxmaj red xxmaj rock xxmaj west is one of those rare films that keeps you guessing the entire time as to what will happen next . xxmaj nicolas xxmaj cage is mistaken for a contract killer as he enters a small town trying to find work . xxmaj dennis</td>
      <td>'s teeth and cut out her tongue with no xxunk ? xxmaj overall awesome flick , but not for everyone . xxbos xxmaj red xxmaj rock xxmaj west is one of those rare films that keeps you guessing the entire time as to what will happen next . xxmaj nicolas xxmaj cage is mistaken for a contract killer as he enters a small town trying to find work . xxmaj dennis xxmaj</td>
      <td>and daughter , her out her hair . a xxunk . xxmaj the , movie . but it as me . xxmaj xxmaj this xxmaj rock xxmaj west is a of the films films that you you interested . entire time . you what is happen next . xxmaj the xxmaj cage is xxmaj for a xxunk agent as a has a xxunk town . to find out . xxmaj he xxmaj</td>
    </tr>
    <tr>
      <th>4</th>
      <td>are not allowed to attend soccer xxunk , so the nation 's armed forces have been xxunk to save any women who try to enter from themselves . xxmaj some ( teen ? ) girls try to crash the party by dressing as boys , but are caught . xxmaj the movie is mostly set at this holding pen where the girls are xxunk by soldiers , xxunk some xxunk punishment (</td>
      <td>not allowed to attend soccer xxunk , so the nation 's armed forces have been xxunk to save any women who try to enter from themselves . xxmaj some ( teen ? ) girls try to crash the party by dressing as boys , but are caught . xxmaj the movie is mostly set at this holding pen where the girls are xxunk by soldiers , xxunk some xxunk punishment ( although</td>
      <td>not the to xxunk the xxunk . but they girls is armed forces have been xxunk to xxunk the women who are to live the their . xxmaj the of including ) ) girls are to xxunk the country by xxunk as boys . but they xxunk and xxmaj the girls is so shot in the xxunk place , a girls are xxunk and a , and and xxunk xxunk . and</td>
    </tr>
    <tr>
      <th>5</th>
      <td>good . xxmaj it 's my personal favorite of all the " christmas xxmaj carol " movies because every aspect of this production are of the highest quality . xxmaj yes , there are some minor on screen xxunk with two of the ghosts that visit xxmaj scrooge , but there is n't a movie in existence that does n't have at least a couple of mistakes . \n\n xxmaj scott turns</td>
      <td>. xxmaj it 's my personal favorite of all the " christmas xxmaj carol " movies because every aspect of this production are of the highest quality . xxmaj yes , there are some minor on screen xxunk with two of the ghosts that visit xxmaj scrooge , but there is n't a movie in existence that does n't have at least a couple of mistakes . \n\n xxmaj scott turns in</td>
      <td>, xxmaj the 's a favorite favorite . all the xxmaj xxunk xxmaj carol " movies . it aspect of the film is the the same quality . xxmaj the , this are a good moments screen xxunk , the of the best , are the xxunk . but this are no a lot in the that is n't have a least a lot of laughs . xxmaj xxmaj the xxmaj in</td>
    </tr>
    <tr>
      <th>6</th>
      <td>" la xxmaj xxunk xxmaj xxunk " with the original soundtrack " xxunk " as an alternative language , since despite searching i could not find a wholly xxmaj english xxunk was however xxunk to see another performance by xxmaj ella xxmaj raines after being impressed with her performance as a heroine in " impact " playing a sole female xxunk xxunk xxmaj ella performs another heroic role believing in the innocence</td>
      <td>la xxmaj xxunk xxmaj xxunk " with the original soundtrack " xxunk " as an alternative language , since despite searching i could not find a wholly xxmaj english xxunk was however xxunk to see another performance by xxmaj ella xxmaj raines after being impressed with her performance as a heroine in " impact " playing a sole female xxunk xxunk xxmaj ella performs another heroic role believing in the innocence of</td>
      <td>xxunk xxmaj xxunk " xxunk " ( xxmaj xxmaj " . xxunk xxmaj . well xxunk song . and it the for would n't find any new original english - in actually xxunk . the xxmaj of by xxmaj xxunk xxmaj raines in being xxunk with her performance . a xxunk . " xxunk " . a xxunk female xxunk . . xxunk xxmaj a xxunk role in in the xxunk of</td>
    </tr>
    <tr>
      <th>7</th>
      <td>i mentioned before , quite dated and very simple . xxmaj the least detailed of basically any 3d game released by a professional team of creators . xxmaj if you can get over that , xxunk some would suggest that this simplicity only adds to the effect the game has on you ) , then you 've got one heck of a good shooter / xxunk game . xxmaj the game play</td>
      <td>mentioned before , quite dated and very simple . xxmaj the least detailed of basically any 3d game released by a professional team of creators . xxmaj if you can get over that , xxunk some would suggest that this simplicity only adds to the effect the game has on you ) , then you 've got one heck of a good shooter / xxunk game . xxmaj the game play consists</td>
      <td>was was . but recently and very little . xxmaj the acting interesting is the any movie game is by xxup professional team of xxunk . xxmaj the you are find a the , you you of be that you is is xxunk to the quality it game has on you . . but you will got to of of a xxunk game / xxunk game . xxmaj it game is is</td>
    </tr>
    <tr>
      <th>8</th>
      <td>more likely that the xxmaj british simply saw the xxunk between the xxunk and were clever enough to exploit them to their own ends . \n\n xxmaj the result is that there is much cruelty and inhumanity in the situation and this is very unpleasant to remember and to see on the screen . xxmaj but it is never painted as a black - and - white case . xxmaj there is</td>
      <td>likely that the xxmaj british simply saw the xxunk between the xxunk and were clever enough to exploit them to their own ends . \n\n xxmaj the result is that there is much cruelty and inhumanity in the situation and this is very unpleasant to remember and to see on the screen . xxmaj but it is never painted as a black - and - white case . xxmaj there is xxunk</td>
      <td>than . the film xxunk would had the film of the xxmaj and the xxunk enough to keep them . xxunk own side . xxmaj xxmaj the xxmaj is a the is a more and violence in the film . the is a well . watch . to be . the screen . xxmaj the it is a a as a black - and - white film . xxmaj the are a</td>
    </tr>
    <tr>
      <th>9</th>
      <td>, as if improvised by bored actors , popping out of nothingness into nothingness . \n\n xxmaj modern art has finally succeeded in xxunk the thing without being the thing , so that what we behold is the idea of the idea , empty as a shell , but not even a shell , merely the idea of a shell . xxmaj could one ask for a better definition of xxunk ?</td>
      <td>as if improvised by bored actors , popping out of nothingness into nothingness . \n\n xxmaj modern art has finally succeeded in xxunk the thing without being the thing , so that what we behold is the idea of the idea , empty as a shell , but not even a shell , merely the idea of a shell . xxmaj could one ask for a better definition of xxunk ? xxbos</td>
      <td>and a it by xxmaj actors , they out of the . a . xxmaj xxmaj the xxmaj has been been in xxunk the xxunk with resorting a least that but it it is see is a xxunk of a xxunk of which and a whole . and it as a xxunk . and a xxunk of a xxunk . xxmaj the n't xxunk for a xxunk time of xxunk , xxmaj</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save_encoder</span><span class="p">(</span><span class="s1">&#39;enc1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-it-to-train-a-classifier">Use it to train a classifier<a class="anchor-link" href="#Use-it-to-train-a-classifier">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For classification, we need to use two set of transforms: one to numericalize the texts and the other to encode the labels as categories. Note that we have to use the same vocabulary as the one used in fine-tuning the language model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lm_vocab</span> <span class="o">=</span> <span class="n">dbunch</span><span class="o">.</span><span class="n">vocab</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">()(</span><span class="n">df</span><span class="p">)</span>
<span class="n">x_tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Numericalize</span><span class="p">(</span><span class="n">vocab</span><span class="o">=</span><span class="n">lm_vocab</span><span class="p">)]</span>
<span class="n">dsrc</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span><span class="n">x_tfms</span><span class="p">,</span> <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">),</span> <span class="n">Categorize</span><span class="p">()]],</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">SortedDL</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We once again use a subclass of <a href="/data.core#TfmdDL"><code>TfmdDL</code></a> for the dataloaders, since we want to sort the texts (sortish for the training set) by order of lengths. We also use <code>pad_collate</code> to create batches form texts of different lengths.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">dsrc</span><span class="o">.</span><span class="n">databunch</span><span class="p">(</span><span class="n">before_batch</span><span class="o">=</span><span class="n">pad_input</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And there is a factory method, once again:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">TextDataBunch</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text_vocab</span><span class="o">=</span><span class="n">lm_vocab</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">valid_col</span><span class="o">=</span><span class="s1">&#39;is_valid&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj raising xxmaj victor xxmaj vargas : a xxmaj review \n\n xxmaj you know , xxmaj raising xxmaj victor xxmaj vargas is like sticking your hands into a big , xxunk bowl of xxunk . xxmaj it 's warm and gooey , but you 're not sure if it feels right . xxmaj try as i might , no</td>
      <td>negative</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos xxup the xxup shop xxup around xxup the xxup corner is one of the xxunk and most feel - good romantic comedies ever made . xxmaj there 's just no getting around that , and it 's hard to actually put one 's feeling for this film into words . xxmaj it 's not one of those films that</td>
      <td>positive</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we once again have a convenience function to create a classifier from this <a href="/data.core#DataBunch"><code>DataBunch</code></a> with the <a href="/text.models.awdlstm#AWD_LSTM"><code>AWD_LSTM</code></a> architecture.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">text_classifier_learner</span><span class="p">(</span><span class="n">dbunch</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span><span class="n">drop_mult</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">load_encoder</span><span class="p">(</span><span class="s1">&#39;enc1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we can train with gradual unfreezing and differential learning rates.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.727597</td>
      <td>0.584302</td>
      <td>0.745000</td>
      <td>00:05</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.606741</td>
      <td>0.504984</td>
      <td>0.745000</td>
      <td>00:05</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.530358</td>
      <td>0.477460</td>
      <td>0.765000</td>
      <td>00:05</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.476057</td>
      <td>0.470573</td>
      <td>0.745000</td>
      <td>00:05</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="s2">&quot;This was a good movie&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.interpret</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span> <span class="o">=</span> <span class="n">Interpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">plot_top_losses</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

