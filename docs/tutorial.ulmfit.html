---

title: Transfer learning in text

keywords: fastai
sidebar: home_sidebar

summary: "How to fine-tune a language model and train a classifier"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/38_tutorial.ulmfit.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.basics</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai2.text.all</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai2.callback.all</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># all_slow</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Finetune-a-pretrained-Language-Model">Finetune a pretrained Language Model<a class="anchor-link" href="#Finetune-a-pretrained-Language-Model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we get our data and tokenize it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">IMDB_SAMPLE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;texts.csv&#39;</span><span class="p">)</span>
<span class="n">df_tok</span><span class="p">,</span><span class="n">count</span> <span class="o">=</span> <span class="n">tokenize_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we put it in a <a href="data.core.html#DataSource"><code>DataSource</code></a>. For a language model, we don't have targets, so there is only one transform to numericalize the texts. Note that <a href="text.core.html#tokenize_df"><code>tokenize_df</code></a> returns the count of the words in the corpus to make it easy to create a vocabulary.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">()(</span><span class="n">df_tok</span><span class="p">)</span>
<span class="n">vocab</span> <span class="o">=</span> <span class="n">make_vocab</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
<span class="n">dsrc</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="n">df_tok</span><span class="p">,</span> <span class="p">[[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Numericalize</span><span class="p">(</span><span class="n">vocab</span><span class="p">)]],</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">LMDataLoader</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we use that <a href="data.core.html#DataSource"><code>DataSource</code></a> to create a <a href="data.core.html#DataBunch"><code>DataBunch</code></a>. Here the class of <a href="data.core.html#TfmdDL"><code>TfmdDL</code></a> we need to use is <a href="text.data.html#LMDataLoader"><code>LMDataLoader</code></a> which will concatenate all the texts in a source (with a shuffle at each epoch for the training set), split it in <code>bs</code> chunks then read continuously through it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">dsrc</span><span class="o">.</span><span class="n">databunch</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">Cuda</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or more simply with a factory method:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">TextDataBunch</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df_tok</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text_vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span> <span class="n">is_lm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>text_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos i saw this movie once as a kid on the late - late show and fell in love with it . \n\n xxmaj it took 30 + years , but i recently did find it on xxup dvd - it was n't cheap , either - in a catalog that xxunk in war movies . xxmaj we watched it last night for the first time . xxmaj the audio was good</td>
      <td>i saw this movie once as a kid on the late - late show and fell in love with it . \n\n xxmaj it took 30 + years , but i recently did find it on xxup dvd - it was n't cheap , either - in a catalog that xxunk in war movies . xxmaj we watched it last night for the first time . xxmaj the audio was good ,</td>
    </tr>
    <tr>
      <th>1</th>
      <td>least they can be . xxmaj they have made some good films and had some incredibly funny performances along the way . xxmaj but in here , not only does the premise xxunk all logic , not only is the acting terrible , not only is the entire movie offensive from start to finish , not only is the direction as amateurish as you can find , but they actually want you</td>
      <td>they can be . xxmaj they have made some good films and had some incredibly funny performances along the way . xxmaj but in here , not only does the premise xxunk all logic , not only is the acting terrible , not only is the entire movie offensive from start to finish , not only is the direction as amateurish as you can find , but they actually want you to</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we have a convenience method to directly grab a <a href="learner.html#Learner"><code>Learner</code></a> from it, using the <a href="text.models.awdlstm.html#AWD_LSTM"><code>AWD_LSTM</code></a> architecture.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">language_model_learner</span><span class="p">(</span><span class="n">dbunch</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">Perplexity</span><span class="p">()],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">opt_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.426387</td>
      <td>4.004548</td>
      <td>0.275322</td>
      <td>54.847004</td>
      <td>00:14</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>perplexity</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>4.373950</td>
      <td>4.376214</td>
      <td>0.240014</td>
      <td>79.536301</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>1</td>
      <td>4.298529</td>
      <td>4.310582</td>
      <td>0.250852</td>
      <td>74.483803</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>2</td>
      <td>3.891712</td>
      <td>4.226720</td>
      <td>0.259793</td>
      <td>68.492233</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>3</td>
      <td>3.400854</td>
      <td>4.267030</td>
      <td>0.260507</td>
      <td>71.309547</td>
      <td>00:16</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once we have fine-tuned the pretrained language model to this corpus, we save the encoder since we will use it for the classifier.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>input</th>
      <th>target</th>
      <th>pred</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj bill xxmaj paxton , of xxmaj aliens , xxmaj near xxmaj dark , and xxmaj xxunk fame , surprises me with his debut as director for xxmaj xxunk . xxmaj he hits on all xxunk , but there is one implausibility near the end that involves the xxup fbi agent ( powers xxmaj booth ) which xxunk a point from this otherwise chilling and thought provoking thriller . xxmaj other</td>
      <td>xxmaj bill xxmaj paxton , of xxmaj aliens , xxmaj near xxmaj dark , and xxmaj xxunk fame , surprises me with his debut as director for xxmaj xxunk . xxmaj he hits on all xxunk , but there is one implausibility near the end that involves the xxup fbi agent ( powers xxmaj booth ) which xxunk a point from this otherwise chilling and thought provoking thriller . xxmaj other than</td>
      <td>xxmaj this xxmaj paxton is xxmaj course xxunk , xxmaj xxunk xxmaj dark , and xxmaj xxunk xxmaj , are in with a xxunk . xxmaj and xxmaj xxunk xxmaj xxmaj the is the a the , and the is no thing in the end that is a two fbi agent ( powers xxmaj boothe ) who is his xxunk in the film xxunk and xxunk - thriller . xxmaj the than</td>
    </tr>
    <tr>
      <th>1</th>
      <td>'ll find out why they could become annoying ( http : / / xxunk / xxunk ) . xxmaj the main villain i guess is bad luck , fate , hand of xxmaj god ( no xxunk intended ) , or just plain xxmaj xxunk xxmaj xxunk ( billy xxmaj xxunk ) . xxmaj combine all of the above and what do you get ? ! xxmaj oh yes ! xxmaj we</td>
      <td>find out why they could become annoying ( http : / / xxunk / xxunk ) . xxmaj the main villain i guess is bad luck , fate , hand of xxmaj god ( no xxunk intended ) , or just plain xxmaj xxunk xxmaj xxunk ( billy xxmaj xxunk ) . xxmaj combine all of the above and what do you get ? ! xxmaj oh yes ! xxmaj we get</td>
      <td>be out that xxmaj were n't xxunk . xxunk : / / / / xxunk ) . xxmaj the plot character is would is xxmaj guy , and , and - xxmaj god , the one ) ) , or just a bad xxunk xxmaj xxunk ( xxunk xxmaj xxunk ) . xxmaj the all of the xxunk , the is you want ? xxmaj xxmaj the , , xxmaj the 're</td>
    </tr>
    <tr>
      <th>2</th>
      <td>bernie xxmaj xxunk . xxmaj alfred develops a sort of " xxunk love " for xxmaj bernie while our young xxmaj zeon pilot also falls for xxmaj christina . \n\n " war in the xxmaj pocket " proves that you do not need a sweeping epic tale about special individuals to make for a good war story . xxmaj there are no xxunk xxunk pilots or large scale fleet battles to be</td>
      <td>xxmaj xxunk . xxmaj alfred develops a sort of " xxunk love " for xxmaj bernie while our young xxmaj zeon pilot also falls for xxmaj christina . \n\n " war in the xxmaj pocket " proves that you do not need a sweeping epic tale about special individuals to make for a good war story . xxmaj there are no xxunk xxunk pilots or large scale fleet battles to be seen</td>
      <td>xxmaj xxunk ( xxmaj he is a xxunk of xxunk xxunk " " for xxmaj bernie . his two xxmaj xxunk pilot is falls in xxmaj bernie . xxmaj xxmaj the " the xxmaj gold " is that the can n't know to lot xxunk story about the xxunk . create a a good war story . xxmaj the is some real in in , xxunk xxunk xxunk battles , be seen</td>
    </tr>
    <tr>
      <th>3</th>
      <td>xxmaj it is 100 % visual xxunk : he gets his kicks by making the actors strip in the buff and look at their xxunk . xxmaj and if he does this in front of the audience , he might eve get a hard - on ! xxmaj did you know that , on the set of " xxunk xxmaj xxunk " , he used to xxunk poor xxmaj coca xxmaj xxunk</td>
      <td>it is 100 % visual xxunk : he gets his kicks by making the actors strip in the buff and look at their xxunk . xxmaj and if he does this in front of the audience , he might eve get a hard - on ! xxmaj did you know that , on the set of " xxunk xxmaj xxunk " , he used to xxunk poor xxmaj coca xxmaj xxunk ,</td>
      <td>xxunk 's a % xxunk xxunk , xxmaj is his xxunk in making a movie look in the middle and xxunk at the xxunk . xxmaj the the you 's n't , the of the camera , he is be be a xxunk - to - xxmaj he n't really that he he the other of the xxunk xxmaj xxunk " , he 's to be his xxmaj xxunk xxmaj xxunk ,</td>
    </tr>
    <tr>
      <th>4</th>
      <td>and good nature . xxmaj not to mention amusing , xxunk dialogue . xxmaj after xxmaj adeline has taken steps to save xxmaj fanfan from hanging , she meets the king in his private quarters . " give me your pretty little hand , " he says . " but my heart xxunk to xxmaj fanfan , " says xxmaj adeline . " who asks for your heart ? " says the</td>
      <td>good nature . xxmaj not to mention amusing , xxunk dialogue . xxmaj after xxmaj adeline has taken steps to save xxmaj fanfan from hanging , she meets the king in his private quarters . " give me your pretty little hand , " he says . " but my heart xxunk to xxmaj fanfan , " says xxmaj adeline . " who asks for your heart ? " says the king</td>
      <td>the . . xxmaj the only mention the acting xxunk , , xxmaj the all xxunk 's died her to save her fanfan from xxunk , she is xxmaj king 's the mouth quarters . xxmaj we me a heart little head " " says says " " you i friend xxunk ! xxmaj fanfan ! " says xxmaj adeline . xxmaj i knows for me heart ? " xxmaj xxmaj king</td>
    </tr>
    <tr>
      <th>5</th>
      <td>. \n\n xxmaj no , this film is n't terrible . xxmaj other than the laughable screenplay , it is n't poor . xxmaj the actors are all experienced and perform well here . xxmaj xxunk xxmaj xxunk , who plays xxmaj sajani , was part of wonderful xxmaj indian drama xxmaj water . xxmaj even director xxmaj sivan has an impressive xxunk . xxmaj he recently xxunk xxmaj the xxmaj terrorist</td>
      <td>\n\n xxmaj no , this film is n't terrible . xxmaj other than the laughable screenplay , it is n't poor . xxmaj the actors are all experienced and perform well here . xxmaj xxunk xxmaj xxunk , who plays xxmaj sajani , was part of wonderful xxmaj indian drama xxmaj water . xxmaj even director xxmaj sivan has an impressive xxunk . xxmaj he recently xxunk xxmaj the xxmaj terrorist ,</td>
      <td>xxmaj xxmaj the , no movie is not a . xxmaj it than that fact acting , it 's a even . xxmaj the acting are not very with very well . . xxmaj the xxmaj xxunk is xxmaj plays xxmaj xxunk , is a of the xxmaj xxunk history . xxunk . xxmaj the though xxmaj xxunk 's been amazing cast . xxmaj he is made the the xxmaj xxunk ,</td>
    </tr>
    <tr>
      <th>6</th>
      <td>xxunk . xxmaj this is the movie in a xxunk . xxmaj then there is the bad acting and insipid dialogue . i actually have a lot of patience when it comes to b movies . xxmaj this one is xxunk . xxmaj by the way , a more xxunk title would be xxmaj revolt of the xxmaj hypnotized . xxbos xxmaj if somebody wants to make a really , xxup really</td>
      <td>. xxmaj this is the movie in a xxunk . xxmaj then there is the bad acting and insipid dialogue . i actually have a lot of patience when it comes to b movies . xxmaj this one is xxunk . xxmaj by the way , a more xxunk title would be xxmaj revolt of the xxmaj hypnotized . xxbos xxmaj if somebody wants to make a really , xxup really bad</td>
      <td>xxmaj xxmaj the is a only 's which xxunk , xxmaj it , is a xxunk acting , the dialogue . xxmaj think liked to lot of time to i comes to xxmaj movies . xxmaj the is is a . xxmaj it the way , it movie realistic , is be a xxunk of the xxmaj hypnotized . xxmaj xxmaj this you has to see a movie good good tv good</td>
    </tr>
    <tr>
      <th>7</th>
      <td>, one might hope that at least the critical " facts " that the story turns on might be based on actual events . xxmaj reagan was shot and the other characters were real people . xxmaj the movie got that right . xxmaj from there on , xxunk on facts rapidly xxunk . i had never heard of this movie before seeing it . xxmaj having been a xxup tv reporter</td>
      <td>one might hope that at least the critical " facts " that the story turns on might be based on actual events . xxmaj reagan was shot and the other characters were real people . xxmaj the movie got that right . xxmaj from there on , xxunk on facts rapidly xxunk . i had never heard of this movie before seeing it . xxmaj having been a xxup tv reporter at</td>
      <td>and of not that the least the xxunk xxunk xxunk " are this film is into are be a on the events . xxmaj the 's n't and was xxunk characters were xxunk . . xxmaj the film was a much . xxmaj the the , , the the the , xxunk . xxmaj was to heard of the movie before i it . xxmaj the read xxunk fan tv fan ,</td>
    </tr>
    <tr>
      <th>8</th>
      <td>looking and young , and so he gives xxmaj jackman nothing to say or do . xxmaj like xxmaj johansson , he is used merely for his good looks . xxmaj this is a shame , because , as xxmaj jackman has shown in any number of productions , from " oklahoma " to " x xxmaj men , " he xxup can act . \n\n xxmaj here 's the big plot</td>
      <td>and young , and so he gives xxmaj jackman nothing to say or do . xxmaj like xxmaj johansson , he is used merely for his good looks . xxmaj this is a shame , because , as xxmaj jackman has shown in any number of productions , from " oklahoma " to " x xxmaj men , " he xxup can act . \n\n xxmaj here 's the big plot twist</td>
      <td>for looking people xxunk the on 's us xxunk a to do about do . xxmaj the xxmaj xxunk , he 's a to to his xxunk acting . xxmaj he is a very , because he as a jackman is done , his other of movies , he the xxunk " to " xxunk xxmaj men " " he 's is not as xxmaj xxmaj the , a only - twist</td>
    </tr>
    <tr>
      <th>9</th>
      <td>probably the worst movie i have ever seen . xxmaj here are the things that immediately jump out at me : 1 . xxmaj the woods were more like hills in xxmaj los xxmaj angeles with a couple trees and xxunk . xxmaj not scary whatsoever . xxmaj news flash , if you are filming in the xxmaj southern xxmaj california area , big bear is only an hour away . xxmaj</td>
      <td>the worst movie i have ever seen . xxmaj here are the things that immediately jump out at me : 1 . xxmaj the woods were more like hills in xxmaj los xxmaj angeles with a couple trees and xxunk . xxmaj not scary whatsoever . xxmaj news flash , if you are filming in the xxmaj southern xxmaj california area , big bear is only an hour away . xxmaj they</td>
      <td>not best movie i have ever seen . xxmaj the 's the things that are happen out of the . xxmaj . xxmaj the acting are xxunk like a in xxmaj xxunk xxmaj angeles . a couple of , xxunk . xxmaj the only . . xxmaj the xxunk , but you 're looking in the woods xxunk xxmaj california area , you xxunk is just a hour away . xxmaj the</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save_encoder</span><span class="p">(</span><span class="s1">&#39;enc1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Use-it-to-train-a-classifier">Use it to train a classifier<a class="anchor-link" href="#Use-it-to-train-a-classifier">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For classification, we need to use two set of transforms: one to numericalize the texts and the other to encode the labels as categories.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splits</span> <span class="o">=</span> <span class="n">ColSplitter</span><span class="p">()(</span><span class="n">df_tok</span><span class="p">)</span>
<span class="n">dsrc</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="n">df_tok</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="p">[</span>
    <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">Numericalize</span><span class="p">(</span><span class="n">vocab</span><span class="p">)],</span>
    <span class="p">[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">),</span> <span class="n">Categorize</span><span class="p">()]],</span> <span class="n">dl_type</span><span class="o">=</span><span class="n">SortedDL</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We opnce again use a subclass of <a href="data.core.html#TfmdDL"><code>TfmdDL</code></a> for the dataloaders, since we want to sort the texts (sortish for the training set) by order of lengths. We also use <code>pad_collate</code> to create batches form texts of different lengths.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">dsrc</span><span class="o">.</span><span class="n">databunch</span><span class="p">(</span><span class="n">before_batch</span><span class="o">=</span><span class="n">pad_input</span><span class="p">,</span> <span class="n">after_batch</span><span class="o">=</span><span class="n">Cuda</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj raising xxmaj victor xxmaj vargas : a xxmaj review \n\n xxmaj you know , xxmaj raising xxmaj victor xxmaj vargas is like sticking your hands into a big , xxunk bowl of xxunk . xxmaj it 's warm and gooey , but you 're not sure if it feels right . xxmaj try as i might , no</td>
      <td>negative</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos xxup the xxup shop xxup around xxup the xxup corner is one of the xxunk and most feel - good romantic comedies ever made . xxmaj there 's just no getting around that , and it 's hard to actually put one 's feeling for this film into words . xxmaj it 's not one of those films that</td>
      <td>positive</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or with a factory method of <a href="text.data.html#TextDataBunch"><code>TextDataBunch</code></a>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbunch</span> <span class="o">=</span> <span class="n">TextDataBunch</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df_tok</span><span class="p">,</span> <span class="n">text_col</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text_vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we once again have a convenience function to create a classifier from this <a href="data.core.html#DataBunch"><code>DataBunch</code></a> with the <a href="text.models.awdlstm.html#AWD_LSTM"><code>AWD_LSTM</code></a> architecture.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">text_classifier_learner</span><span class="p">(</span><span class="n">dbunch</span><span class="p">,</span> <span class="n">AWD_LSTM</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">accuracy</span><span class="p">],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">Adam</span><span class="p">,</span> <span class="n">drop_mult</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">load_encoder</span><span class="p">(</span><span class="s1">&#39;enc1&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we can train with gradual unfreezing and differential learning rates.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.720599</td>
      <td>0.496283</td>
      <td>0.765000</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.580163</td>
      <td>0.465498</td>
      <td>0.790000</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.502125</td>
      <td>0.460327</td>
      <td>0.760000</td>
      <td>00:09</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.461802</td>
      <td>0.448796</td>
      <td>0.765000</td>
      <td>00:11</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">),</span> <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.411823</td>
      <td>0.399018</td>
      <td>0.810000</td>
      <td>00:15</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.397232</td>
      <td>0.416813</td>
      <td>0.815000</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.373783</td>
      <td>0.486226</td>
      <td>0.785000</td>
      <td>00:17</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.315111</td>
      <td>0.422542</td>
      <td>0.825000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.282453</td>
      <td>0.421409</td>
      <td>0.830000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.251479</td>
      <td>0.422410</td>
      <td>0.820000</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.245852</td>
      <td>0.444412</td>
      <td>0.810000</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.221122</td>
      <td>0.416276</td>
      <td>0.820000</td>
      <td>00:18</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
      <th>category_</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxup the xxup shop xxup around xxup the xxup corner is one of the xxunk and most feel - good romantic comedies ever made . xxmaj there 's just no getting around that , and it 's hard to actually put one 's feeling for this film into words . xxmaj it 's not one of those films that</td>
      <td>positive</td>
      <td>positive</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos xxmaj now that xxmaj che(2008 ) has finished its relatively short xxmaj australian cinema run ( extremely limited xxunk screen in xxmaj xxunk , after xxunk ) , i can xxunk join both xxunk of " at xxmaj the xxmaj movies " in taking xxmaj steven xxmaj soderbergh to task . \n\n xxmaj it 's usually satisfying to watch</td>
      <td>negative</td>
      <td>negative</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai2.interpret</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span> <span class="o">=</span> <span class="n">Interpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">plot_top_losses</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>input</th>
      <th>target</th>
      <th>predicted</th>
      <th>probability</th>
      <th>loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>xxbos xxmaj over xxmaj her xxmaj dead xxmaj body was a nice little xxunk was decent and entertaining , while still being pretty xxunk were a few cliché 's , but i found most stuff xxunk first i did n't think it was going to be good at all , when it started xxunk you can get past the first 20 minutes though , the movie starts getting more xxunk film was n't burst out in laughter hilarious , and was n't xxup oh xxup my xxup xxunk xxunk was just a movie that you can sit down and enjoy for how enjoyable it xxunk do n't see how this movie was xxunk rating is just a bit too xxunk could 've dealt with a xxunk a xxunk , giving this movie a 1 is xxunk was pretty good , and there was nothing horrible enough about it to give</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.9911274313926697</td>
      <td>4.724791526794434</td>
    </tr>
    <tr>
      <th>1</th>
      <td>xxbos xxmaj not sure if it was right or wrong , but i read thru the other comments before watching the xxunk have to say i disagree with most of the negative comments or problems people have had with it . \n\n xxmaj as a first time " lone xxmaj wolf " director / producer , i like to see things that i can xxunk to , not necessarily from the pro 's , but by people just getting their feet wet like me . \n\n xxmaj if indeed this is also from a first - xxunk , as i read , i applaud the xxunk job then in that respect ! xxmaj there were some comments about the xxunk thought it was quite nice for the xxunk say it kind of xxunk along for a while , but i found that created tension xxunk being xxunk of it ,</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.989062488079071</td>
      <td>4.515562057495117</td>
    </tr>
    <tr>
      <th>2</th>
      <td>xxbos xxmaj of life in ( some ) colleges . xxmaj of course there were artistic xxunk taken , but some of what you saw in this film go on in some colleges . \n\n i went to colleges in xxmaj southern xxmaj california where the xxunk pretty much hang around with their own . xxmaj it 's funny because these are schools that want racial xxunk , equality etc . and i can honestly say , that it 's there . xxmaj but the thing is when class lets out , or when they 're just hanging out waiting for class , they ( students ) seem to just hang around with people of their own race or ethnicity . xxmaj is that bad ? xxmaj not really . xxmaj everyone needs a feeling of belonging . xxmaj but like the school paper of one of the schools i</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.9781860709190369</td>
      <td>3.8252058029174805</td>
    </tr>
    <tr>
      <th>3</th>
      <td>xxbos i ca nt help it but i seem to like films that are meant to be scary and are just plain bad . i have personally listed it in my own top 10 worst movies right under creatures of the xxunk xxmaj watch this film and have a laugh just do n't expect to see any academy awards for acting . xxmaj more chance of understanding the film its self . xxmaj in all honesty though i have seen much worse than this . xxmaj plus some xxunk xxunk round the desert xxunk the same people out that just died is that unbelievable that its got to be original . i think its one of those love or hate movies . you can make up your own mind yes its awful but it pulls it off somehow that s why i love it</td>
      <td>negative</td>
      <td>positive</td>
      <td>0.9513773322105408</td>
      <td>3.0236663818359375</td>
    </tr>
    <tr>
      <th>4</th>
      <td>xxbos xxmaj like xxmaj tarzan the xxmaj ape xxmaj man ( 1932 ) , only more so . xxmaj there 's more of everything , more animals , more varied xxmaj african tribes , and scenes in which the thought must be , if this was good with three or four lions , forty would be better . xxmaj tarzan xxunk with xxunk the crocodile machine xxunk in the water like a rolling pin , around and around , jaws xxunk . xxmaj tarzan can kill it with his xxunk knife if the xxunk xxunk would hold still . xxmaj tarzan kills lions and xxunk and a xxunk xxunk number of animals . xxmaj his friends are real xxunk , people wearing larger ape costumes , and xxunk . xxmaj in fact , they use xxmaj indian xxunk more friendly and xxunk than xxmaj african xxunk costume ears attached to</td>
      <td>positive</td>
      <td>negative</td>
      <td>0.9405072331428528</td>
      <td>2.821899890899658</td>
    </tr>
    <tr>
      <th>5</th>
      <td>xxbos xxmaj this is yet another bad movie that you should probably avoid watching . xxmaj the plot could be a lot " xxunk " than it actually is and would be better made as a blockbuster type movie . \n\n xxmaj the acting leaves something to be desired , though you can not quite place your finger on what it is . \n\n xxmaj this is one of those that you watch on late night xxup tv , perhaps on xxup usa , simply because you can not get to sleep . xxmaj watch it if you want but do not expect too much from it .</td>
      <td>negative</td>
      <td>positive</td>
      <td>0.9324377179145813</td>
      <td>2.6947054862976074</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
</div>
 

